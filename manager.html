<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>YOUR RESTAURANT NAME â€” Manager Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    .order-type-badge { font-size:12px; font-weight:bold; border-radius:7px; padding:2px 8px; margin-right:6px }
    .order-type-dinein { background:#fbbf24; color:#222; }
    .order-type-takeaway { background:#34d399; color:#222; }
    .order-type-delivery { background:#60a5fa; color:#fff; }
    .card-btn { transition: transform 0.1s; }
    .card-btn:hover { transform: scale(1.05); }
    .insight-label { color: #b45309; font-weight: bold; font-size: 1.13rem; letter-spacing: .8px; }
    .insight-select, .insight-input { font-weight: bold; font-size: 1.13rem; background: #fffbe8; color: #7c4700; border: 2px solid #fbbf24; border-radius: 6px; padding: 6px 10px; }
    .insight-box { background: #fffbe8; border: 3px solid #fbbf24; border-radius: 16px; padding: 24px; margin-top: 16px; color: #4c1d06; font-size: 1.13rem; }
    .insight-result-table th, .insight-result-table td { border-bottom: 2px solid #fbbf24; padding: 8px 12px!important; font-size:1.12em; }
    .insight-big-value { font-size:2.0em;font-weight:800; color:#a16207; }
    .insight-mid-value { font-size:1.15em;font-weight:700;}
  </style>
</head>
<body class="bg-gradient-to-b from-slate-900 via-gray-900 to-black text-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <header class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-4xl font-extrabold text-amber-300">YOUR RESTAURANT NAME â€” Manager</h1>
        <p class="text-sm text-gray-400">
          Contact: <b>+91-XXXXXXXXXX</b> â€¢ Date wise orders, order type & status
        </p>
      </div>
      <a href="/index.html" class="px-4 py-2 bg-gray-800 rounded text-gray-200">Customer View</a>
    </header>

    <!-- DASHBOARD -->
    <section id="dashboard" class="bg-white rounded-xl p-6 mb-8 shadow-xl border border-gray-300">
      <div class="flex flex-wrap gap-4 mb-4 items-center">
        <h2 class="text-2xl font-extrabold text-gray-800">ðŸ“Š Dashboard</h2>
        <label class="ml-4 insight-label">View:
          <select id="dashboardPeriod" class="ml-2 insight-select">
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month">Month</option>
          </select>
        </label>
        <label class="ml-4 insight-label">Date:
          <input id="dashboardDate" type="date" class="ml-2 insight-input" />
        </label>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-amber-50 border border-yellow-200 rounded-lg p-4 text-center">
          <div class="text-lg font-bold text-amber-700" id="sales-today">â‚¹0</div>
          <div class="text-xs mt-2 text-gray-700">Sales</div>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
          <div class="text-lg font-bold text-green-700" id="orders-month">0</div>
          <div class="text-xs mt-2 text-gray-700">Orders</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
          <div class="text-lg font-bold text-blue-700" id="peak-hour">-</div>
          <div class="text-xs mt-2 text-gray-700">Peak Hour</div>
        </div>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
          <div class="text-lg font-bold text-red-700" id="top-dish">-</div>
          <div class="text-xs mt-2 text-gray-700">Most Ordered</div>
        </div>
      </div>
    </section>

    <!-- INSIGHTS -->
    <section class="bg-white border-4 border-yellow-500 shadow-lg rounded-xl py-10 px-8 my-10">
      <h3 class="text-2xl font-extrabold text-yellow-800 mb-7 tracking-wider">ðŸ“Š Detailed Insights & Comparison</h3>
      <form class="flex flex-wrap gap-7 items-center mb-4">
        <label class="insight-label">Insight:
          <select id="insightType" class="insight-select ml-1">
            <option value="compare_sales">Sales Comparison</option>
            <option value="repeat_customers">Repeat Customers (in period)</option>
            <option value="best_dish">Most Ordered Dish (period)</option>
            <option value="customer_search">Look-up Customer Visits (by name)</option>
          </select>
        </label>
        <label id="compareByLabel" style="display:none;" class="insight-label ml-1">Compare by:
          <select id="compareBy" class="insight-select ml-1">
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month">Month</option>
          </select>
        </label>
        <label class="insight-label">First:
          <input type="date" id="insightFrom" class="insight-input ml-1"/>
        </label>
        <label class="insight-label">Second:
          <input type="date" id="insightTo" class="insight-input ml-1"/>
        </label>
        <input id="insightName" class="insight-input ml-1" style="display:none;" placeholder="Customer Name" />
        <button type="button" class="bg-yellow-400 hover:bg-yellow-500 text-black font-extrabold rounded px-5 py-2 ml-2 shadow-lg text-lg" onclick="runInsight()">Show</button>
      </form>
      <div id="insightResult" class="insight-box"></div>
    </section>

    <!-- ORDERS -->
    <div class="bg-gray-800 rounded-2xl p-4 mb-6 flex justify-between items-center">
      <div>
        <label class="text-sm text-gray-400 mr-2">Select Date:</label>
        <input id="datePicker" type="date" class="bg-gray-900 border border-gray-700 p-2 rounded" />
      </div>
      <div class="flex flex-col text-right gap-2">
        <div class="text-sm text-gray-400">Total Orders: <span id="totalOrders" class="font-bold text-amber-300">0</span></div>
        <div class="text-sm text-gray-400">Revenue: â‚¹<span id="totalRevenue" class="font-bold text-green-300">0</span></div>
        <div class="flex gap-3">
          <span class="order-type-badge order-type-dinein">Dine-in: <span id="countDinein">0</span></span>
          <span class="order-type-badge order-type-takeaway">Takeaway: <span id="countTakeaway">0</span></span>
          <span class="order-type-badge order-type-delivery">Delivery: <span id="countDelivery">0</span></span>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <section>
        <h2 class="text-xl font-semibold text-amber-200 mb-4">Upcoming / Incoming Orders</h2>
        <div id="incoming" class="space-y-4"></div>
      </section>
      <section>
        <h2 class="text-xl font-semibold text-green-300 mb-4">Delivered Orders</h2>
        <div id="delivered" class="space-y-4"></div>
      </section>
    </div>
  </div>

  <script>
    const socket = io();

    // ---- ORDER TABLES & SUMMARY ----
    const datePicker = document.getElementById('datePicker');
    datePicker.value = new Date().toISOString().slice(0,10);

    async function fetchOrders(date) {
      const res = await fetch('/api/orders?date=' + date);
      const orders = await res.json();
      render(orders);
    }

    function render(orders) {
      // summary stats
      const dinein = orders.filter(o => o.orderType === 'dinein');
      const takeaway = orders.filter(o => o.orderType === 'takeaway');
      const delivery = orders.filter(o => o.orderType === 'delivery');
      document.getElementById('totalOrders').innerText = orders.length;
      document.getElementById('totalRevenue').innerText = orders.reduce((s,o)=>s+o.total,0);
      document.getElementById('countDinein').innerText = dinein.length;
      document.getElementById('countTakeaway').innerText = takeaway.length;
      document.getElementById('countDelivery').innerText = delivery.length;

      // organize orders
      const incoming = orders.filter(o => o.status !== 'delivered' && o.status !== 'deleted');
      const delivered = orders.filter(o => o.status === 'delivered');

      document.getElementById('incoming').innerHTML = incoming.map(o => cardHtml(o, true)).join('');
      document.getElementById('delivered').innerHTML = delivered.map(o => cardHtml(o, false)).join('');
    }

    function cardHtml(o, isIncoming) {
      return `
        <div class="bg-${isIncoming ? 'gray-900 border border-amber-400' : 'gray-800 border border-gray-700'} rounded-lg p-4 shadow">
          <div class="flex justify-between items-start">
            <div>
              <span class="order-type-badge order-type-${o.orderType}">${o.orderType.charAt(0).toUpperCase() + o.orderType.slice(1)}</span>
              <span class="font-bold text-lg">${o.customerName || '-'}</span>
              <div class="text-xs text-gray-400">${new Date(o.createdAt).toLocaleString()}</div>
              <div class="text-xs text-gray-400 mt-1">${renderOrderDetails(o)}</div>
            </div>
            <div class="text-right">
              <div class="font-semibold ${isIncoming ? 'text-amber-200' : 'text-green-300'}">â‚¹${o.total}</div>
              <div class="text-xs text-gray-400">${o.mobile ? "ðŸ“± " + o.mobile : ""}</div>
            </div>
          </div>
          <ul class="mt-3 text-sm ${isIncoming ? 'text-gray-200' : 'text-gray-300'}">
            ${o.items.map(it=>`<li>â€¢ ${it.qty} Ã— ${formatDisplayName(it)} â€” â‚¹${it.price}</li>`).join('')}
          </ul>
          <div class="mt-3 flex flex-wrap gap-2">
            ${isIncoming ? `
              <button class="card-btn px-3 py-1 bg-blue-600 rounded" onclick="updateStatus('${o._id}','preparing')">Preparing</button>
              <button class="card-btn px-3 py-1 bg-green-600 rounded" onclick="updateStatus('${o._id}','delivered')">Delivered</button>
              <button class="card-btn px-3 py-1 bg-red-600 rounded" onclick="deleteOrder('${o._id}')">Delete</button>
            ` : ``}
            <button class="card-btn px-3 py-1 bg-teal-400 text-black rounded font-bold" onclick='bluetoothPrint(${JSON.stringify(o)})'>Bluetooth Print</button>
          </div>
        </div>
      `;
    }

    function renderOrderDetails(o) {
      if (o.orderType === 'dinein') return `Table: ${o.tableNumber || 'â€”'}`;
      else if (o.orderType === 'takeaway' || o.orderType === 'delivery') return `Address: ${o.address || 'â€”'}`;
      return '';
    }

    // Keep name exactly as visible (prevent showing "m1" etc.)
    function formatDisplayName(it) {
      // If your item has variant/size fields, append them cleanly:
      const variant = it.variant || it.size || it.option || '';
      const v = variant ? ` (${variant})` : '';
      return `${it.name}${v}`;
    }

    async function updateStatus(id, status) {
      await fetch('/api/orders/' + id + '/status', {
        method: 'PATCH',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ status })
      });
    }

    async function deleteOrder(id) {
      if (!confirm('Delete this order?')) return;
      await fetch('/api/orders/' + id + '/status', {
        method: 'PATCH',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ status: 'deleted' })
      });
    }

    // ============ BLUETOOTH PRINT (RawBT intent) ============
    // 58mm (2-inch) printers are ~32 chars/line. We'll format columns:
    // NAME(18) | QTY(4) | AMT(10)  -> total 32 chars
    const LINE_WIDTH = 32;
    function line(char='-') { return char.repeat(LINE_WIDTH) + '\n'; }
    function padRight(str, len) {
      str = (str ?? '').toString();
      return str.length >= len ? str.slice(0, len) : str + ' '.repeat(len - str.length);
    }
    function padLeft(str, len) {
      str = (str ?? '').toString();
      return str.length >= len ? str.slice(0, len) : ' '.repeat(len - str.length) + str;
    }
    function money(n) {
      // ensure integer/2-dec look nice on small receipts
      const v = Number(n || 0);
      return 'â‚¹' + (Number.isInteger(v) ? v : v.toFixed(2));
    }
    function formatItemRow(name, qty, amt) {
      const nameCol = padRight(name, 18);
      const qtyCol  = padLeft(qty.toString(), 4);
      const amtCol  = padLeft(amt, 10);
      return nameCol + qtyCol + amtCol + '\n';
    }

    function buildReceipt(order) {
      // Header
      let out = '';
      out += 'YOUR RESTAURANT NAME\n';
      out += line('-');
      out += `Order Type: ${String(order.orderType || '').toUpperCase()}\n`;
      out += `Customer: ${order.customerName || '-'}\n`;
      if (order.orderType === 'dinein' && order.tableNumber) out += `Table No: ${order.tableNumber}\n`;
      if ((order.orderType === 'delivery' || order.orderType === 'takeaway') && order.address) out += `Address: ${order.address}\n`;
      out += line('-');

      // Column header
      out += formatItemRow('Item', 'Qty', 'Amt');

      // Items
      (order.items || []).forEach(it => {
        const visibleName = formatDisplayName(it); // keep human-friendly, e.g. "Paneer Tikka Masala (Full Plate)"
        const name = visibleName.length > 18 ? visibleName.slice(0,18) : visibleName;
        const amt = money((it.qty || 0) * (it.price || 0));
        out += formatItemRow(name, it.qty || 0, amt);
      });

      out += line('-');

      // TOTAL â€” emphasize with markers to stand out on thermal
      const totalLine = 'TOTAL: ' + money(order.total);
      // Place total right-aligned on the line
      const totalLabel = padRight('TOTAL:', 8); // "TOTAL:" + some space
      const totalAmt = padLeft(money(order.total), LINE_WIDTH - totalLabel.length);
      out += totalLabel + totalAmt + '\n';

      // Meta
      out += `Status: ${order.status || 'incoming'}\n`;
      out += `${new Date(order.createdAt).toLocaleString()}\n`;
      out += '\nThank you! Visit Again\n\n';

      return out;
    }

    function bluetoothPrint(order) {
      try {
        const receipt = buildReceipt(order);
        // RawBT intent scheme
        const uri = 'rawbt:' + encodeURIComponent(receipt);
        // try navigation
        window.location.href = uri;

        // Fallback help (user stays on page; RawBT will handle the intent if installed)
        setTimeout(() => {
          // If nothing happened, user probably doesnâ€™t have RawBT / intent blocked.
          // We wonâ€™t spam alertsâ€”only hint once per click.
          console.info('If printing did not start, install/open RawBT and allow intents.');
        }, 1200);
      } catch (e) {
        alert('Bluetooth print failed: ' + (e.message || e));
      }
    }

    // --- Live updates ---
    datePicker.onchange = () => fetchOrders(datePicker.value);
    socket.on('newOrder', (o) => {
      if ((o.createdAt || '').slice(0,10) === datePicker.value) fetchOrders(datePicker.value);
    });
    socket.on('orderUpdated', (o) => { fetchOrders(datePicker.value); });
    fetchOrders(datePicker.value);

    // ------- DASHBOARD + INSIGHTS (unchanged logic) -------
    const dashboardPeriod = document.getElementById('dashboardPeriod');
    const dashboardDate = document.getElementById('dashboardDate');
    dashboardDate.value = new Date().toISOString().slice(0,10);
    async function renderDashboard() {
      let d = dashboardDate.value, period = dashboardPeriod.value;
      let r = await fetch(`/api/dashboard/sales?period=${period}&date=${d}`); let stats = await r.json();
      document.getElementById('sales-today').textContent = 'â‚¹' + (stats.total || 0);
      document.getElementById('orders-month').textContent = stats.count || 0;

      r = await fetch(`/api/dashboard/peakhour?date=${d}`); let peak = await r.json();
      document.getElementById('peak-hour').textContent = peak ? `${peak._id.hour}:00` : '-';

      r = await fetch(`/api/dashboard/topdish?date=${d}`); let dish = await r.json();
      document.getElementById('top-dish').textContent = dish ? dish._id : '-';
    }
    dashboardPeriod.onchange = dashboardDate.onchange = renderDashboard;
    window.addEventListener('DOMContentLoaded', renderDashboard);

    // ------- INSIGHTS & CHARTS -------
    const compareBy = document.getElementById('compareBy');
    const compareByLabel = document.getElementById('compareByLabel');
    const insightType = document.getElementById('insightType');
    const insightName = document.getElementById('insightName');

    insightType.onchange = () => {
      if(insightType.value === "compare_sales") compareByLabel.style.display = "";
      else compareByLabel.style.display = "none";
      insightName.style.display = (insightType.value === "customer_search") ? "" : "none";
    }

    let myCustomChart = null;
    async function runInsight() {
      const type = insightType.value, from = document.getElementById('insightFrom').value,
            to = document.getElementById('insightTo').value, name = insightName.value, by = compareBy.value || 'day';
      let html = '';

      if(type === "compare_sales") {
        let salesA, salesB, labelA, labelB;
        if(by === "day") {
          salesA = await fetch(`/api/dashboard/sales?period=day&date=${from}`).then(r=>r.json());
          salesB = await fetch(`/api/dashboard/sales?period=day&date=${to}`).then(r=>r.json());
          labelA = from || 'â€”'; labelB = to || 'â€”';
        } else if(by === "week") {
          salesA = await fetch(`/api/dashboard/sales?period=week&date=${from}`).then(r=>r.json());
          salesB = await fetch(`/api/dashboard/sales?period=week&date=${to}`).then(r=>r.json());
          labelA = `Week of ${from || 'â€”'}`; labelB = `Week of ${to || 'â€”'}`;
        } else if(by === "month") {
          salesA = await fetch(`/api/dashboard/sales?period=month&date=${from}`).then(r=>r.json());
          salesB = await fetch(`/api/dashboard/sales?period=month&date=${to}`).then(r=>r.json());
          labelA = `Month: ${(from || 'â€”').slice(0,7)}`; labelB = `Month: ${(to || 'â€”').slice(0,7)}`;
        }

        html = `<div class="mb-6 flex items-center gap-10">
          <div class="bg-yellow-200 rounded-xl p-4 shadow insight-big-value">${labelA}<br>â‚¹${salesA.total||0}<br>
            <span class="insight-mid-value">Orders: ${salesA.count||0}</span></div>
          <div class="bg-yellow-200 rounded-xl p-4 shadow insight-big-value">${labelB}<br>â‚¹${salesB.total||0}<br>
            <span class="insight-mid-value">Orders: ${salesB.count||0}</span></div>
        </div>
        <div class="bg-white rounded-xl py-5 px-2 mb-4 shadow">
          <canvas id="myChart" width="400" height="180"></canvas>
        </div>`;
        document.getElementById('insightResult').innerHTML = html;

        // draw after DOM updated
        setTimeout(()=>{ renderChart([labelA,labelB], [salesA.total,salesB.total], 'Sales Comparison', 'bar'); },0);
        return;
      }

      if(type === "repeat_customers") {
        const data = await fetch(`/api/dashboard/repeatcustomers?from=${from}&to=${to}`).then(r=>r.json());
        html = `<table class="insight-result-table table-auto w-full text-base font-semibold"><thead><tr><th>Name</th><th>Orders</th></tr></thead><tbody>`+
          data.map(c=>`<tr><td>${c._id}</td><td>${c.orders}</td></tr>`).join('')+`</tbody></table>`;
      } else if(type === "best_dish") {
        const dish = await fetch(`/api/dashboard/topdish?from=${from}&to=${to}`).then(r=>r.json());
        html = dish
            ? `<div class="text-2xl font-bold text-yellow-800 mb-2">${dish._id}</div><div class="text-lg">Total Orders: <b>${dish.count}</b></div>`
            : '<div class="text-base text-red-700">No data found in this time frame</div>';
      } else if(type === "customer_search" && name) {
        const data = await fetch(`/api/dashboard/repeatcustomers?from=${from}&to=${to}&name=${encodeURIComponent(name)}`).then(r=>r.json());
        html = data && data.length
         ? `<div class="text-2xl text-yellow-900 font-bold mb-2">${name} visited <span class="font-extrabold text-yellow-900">${data[0].orders}</span> times</div>`
         : `<div class="text-base text-red-700">${name} did not visit in this period.</div>`;
      } else {
        html = '<div class="text-base text-red-700">Choose an insight and date(s).</div>';
      }
      document.getElementById('insightResult').innerHTML = html;
    }

    function renderChart(labels, data, chartLabel, chartType = 'bar') {
      const el = document.getElementById('myChart');
      if (!el) return;
      const ctx = el.getContext('2d');
      if (myCustomChart) myCustomChart.destroy();
      myCustomChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels: labels,
          datasets: [{
            label: chartLabel,
            data: data,
            backgroundColor: 'rgba(251,191,36, 0.7)',
            borderColor: 'rgba(251,191,36, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }
  </script>
</body>
</html>
